---
title: "_01_test"
format: html
---

## 1. data preparation

```{r}

rm(list = ls(all = TRUE))

# libraries needed
library(tidyverse)  # most variable creation here uses tidyverse
library(openxlsx) # for reading/writing Excel files

# 各種の関数セット読み込み
source("../myTools.R")  # プロジェクトルートから読み込む（quarto限定の処理）

# 対象とする年のリスト
yearlist <- c("2007", "2008", "2009", "2010", "2011",
"2012", "2013", "2014", "2015", "2016")
# yearlist <- c("2008")

# DHSデータのルートフォルダを指定
gdrive_dir <- "/Users/snakada/Library/CloudStorage/GoogleDrive-snakada@g.ecc.u-tokyo.ac.jp/マイドライブ/Peru_work/peru_enaho"

# データ保存先フォルダ
save_folder <- "/Users/snakada/Library/CloudStorage/GoogleDrive-snakada@g.ecc.u-tokyo.ac.jp/マイドライブ/Peru_work/peru_enaho/output"

# ENAHOデータのファイルリストを取得
enaho_files_list <- get_enaho_file_list(yearlist, gdrive_dir)
saveRDS(enaho_files_list, file = file.path(save_folder, "enaho_files_list.rds"))

print("open df_mod1...")
df_mod1 <- open_enaho_file("2007", "mod1")
print("open df_mod4...")
df_mod4 <- open_enaho_file("2007", "mod4")
print("open df_mod7...")
df_mod7 <- open_enaho_file("2007", "mod7")
print("open df_summary...")
df_summary <- open_enaho_file("2007", "summary")

setlabels <- function(df, year, file) {
  temp_labels <- getLabelfromDF(df) %>%
  mutate(year = year, file = file) 
  return(temp_labels)
} 
var_labels <- setlabels(df_mod1, "2007", "mod1") %>%
  bind_rows(setlabels(df_mod4, "2007", "mod4")) %>%
  bind_rows(setlabels(df_mod7, "2007", "mod7")) %>%
  bind_rows(setlabels(df_summary, "2007", "summary"))

expenditure_item <- unique(df_mod7$P601A)

write.xlsx(var_labels, file = file.path(save_folder, "var_labels.xlsx"))

var_labels_eng <- read.xlsx(file.path(gdrive_dir, "output", "var_labels_eng.xlsx"))



```
## 2. 必要な関数のセット 


```{r}

# ******************************************************************************
# @title: get_familysize_ame
# @description: 世帯構成員の年齢と性別に基づく家族メンバー数（adult male equivalent）
# @param df_mod4: ENAHOのmod4データフレーム
# @return: 世帯ごとの家族メンバー数と成人男性換算のデータフレーム 
# ******************************************************************************
get_familysize_ame <- function(df_mod4){
  # 年齢計算関数のベクトル化対応版
  calculate_age_vectorized <- function(year1, month1, year2, month2) {
    # ベクトル全体でのNA検証
    if(any(is.na(year1) | is.na(month1) | is.na(year2) | is.na(month2))) {
      warning("Some input values contain NA")
    }
    
    # 1. 暦年差
    age_years <- year2 - year1
    
    # 2. 暦月差  
    raw_months <- month2 - month1
    
    # 3. 月差の調整（ベクトル化対応）
    age_years <- ifelse(raw_months < 0, age_years - 1, age_years)
    age_months <- ifelse(raw_months < 0, raw_months + 12, raw_months)
    
    # 4. 年齢のみを返す
    return(age_years)
  }
  
  # AMEの計算
  calculate_ame <- function(age1, sex1){
    res <- df_AME %>%
      filter(as.numeric(age_min) < as.numeric(age1) & 
               as.numeric(age_max) >= as.numeric(age1) & sex == sex1)
    return(res$AME[1])
  }
  
  df_AME <- read.xlsx(file.path(save_folder, "Human_energy_requirements.xlsx"),
                                sheet = "summary")
  
  # 家族メンバーの計算(AMEの利用)
  df_family_size <- df_mod4 %>%
    mutate(
      P400A2 = ifelse(is.na(P400A2), "6", P400A2),
      P400A3 = ifelse(is.na(P400A3), "1990", P400A3)
    ) %>%
    mutate(
      age = calculate_age_vectorized(as.numeric(P400A3), as.numeric(P400A2), 
                          as.numeric(AÑO), as.numeric(MES)),
      sex_char = ifelse(P207 == 1, "male", "female")
    ) %>%
    # 効率的な結合を使用
    left_join(
      df_AME %>% select(age_min, age_max, sex, AEQ),
      by = c("sex_char" = "sex"),  # 正しい構文
      relationship = "many-to-many"
    ) %>%
    filter(age_min < age & age_max >= age) %>%
    group_by(row_number()) %>%
    slice(1) %>%  # 最初のマッチを選択
    ungroup() %>%
    rename(adult_male_equivalent = AEQ) %>%
    select(-age_min, -age_max, -sex_char) %>%
    summarise(
      family_size = n(),
      family_size_ame = sum(adult_male_equivalent),
      .by = c(CONGLOME, VIVIENDA, HOGAR)
    )
  
  return(df_family_size)  
}
# ------関数ここまで----------------------------------------------------------
# ******************************************************************************
# @title: get_food_consumption
# @description: 世帯の1日あたり食材消費量の計算
# @param df_mod7: ENAHOのmod7データフレーム
# @return: 世帯の1日あたり食材消費量のデータフレーム
# ******************************************************************************
get_food_consumption <- function(df_mod7){
  df_food_consumption <- df_mod7 %>%
    mutate(
      P601A = as.character(P601A),
      P601X = as.character(P601X),
      P601B1 = ifelse(is.na(P601B1), 0, as.numeric(P601B1)),
      P601B2 = ifelse(is.na(P601B2), 0, as.numeric(P601B2)),
      P601B3 = ifelse(is.na(P601B3), 0, as.numeric(P601B3)),
      P601D1 = ifelse(is.na(P601D1), 0, as.numeric(P601D1)),
      P601D2 = ifelse(is.na(P601D2), 0, as.numeric(P601D2)),
      P601D3 = ifelse(is.na(P601D3), 0, as.numeric(P601D3))
    ) %>%
    mutate(
      # 食事消費の頻度計算
      # P601D1の処理(15日が標準の食事調査頻度)
      frequency_days = case_when(
        P601D1 == 1 ~ 15,      # Daily → 15日間毎日
        P601D1 == 2 ~ 7.5,     # Every other day → 15日間で7.5回
        P601D1 == 3 ~ 2.14,    # Weekly → 15日間で約2.14回
        P601D1 == 4 ~ 1.07,    # Biweekly → 15日間で約1.07回
        P601D1 == 5 ~ 0.5,     # Monthly → 15日間で0.5回
        P601D1 == 9 ~ 4.29,    # Twice a week → 15日間で約4.29回
        P601D1 == 10 ~ 6.43,   # Three times a week → 15日間で約6.43回
        is.na(P601D1) ~ 15,    # NA → デフォルト15日間
        TRUE ~ 15               # その他もデフォルト15日間
      ),
      food_unit = case_when(
        P601D3 == 1 ~ 300,  #  bread (grams)
        P601D3 == 2 ~ 1,  #  gram
        P601D3 == 3 ~ 800,  # large sliced bread loaf
        P601D3 == 5 ~ 400,  # small sliced bread loaf
        P601D3 == 8 ~ 200,  # small sponge cake
        P601D3 == 9 ~ 1000,  # kilogram
        P601D3 == 11 ~ 1030, # liter
        P601D3 == 12 ~ 500,  # large_can(milk)
        P601D3 == 13 ~ 250,  # small_can(milk)
        P601D3 == 14 ~ 170,  # 魚缶詰
        P601D3 == 15 ~ 750,  # beer, champagne
        P601D3 == 16 ~ 750,  # beer, champagne
        P601D3 == 17 ~ 750,  # beer, champagne
        P601D3 == 24 ~ 200,  # セロリ
        P601D3 == 29 ~ 100,  # ティーバッグ
        P601D3 == 30 ~ 100,  # 魚のフィレ
        P601D3 == 32 ~ 100,  # 魚の缶詰
        TRUE ~ 1000        # default to kilogram
      )
    ) %>%
    mutate(
      # 食事消費量の計算
      daily_consumption = P601D2 * food_unit / frequency_days
    ) %>%
    select(P601A, P601X, P601B1, P601B2, P601B3, P601D1, P601D2, P601D3,
           frequency_days, food_unit, daily_consumption,
           CONGLOME, VIVIENDA, HOGAR, UBIGEO, DOMINIO, ESTRATO, FACTOR07)

  return(df_food_consumption)
}
# ------関数ここまで----------------------------------------------------------

```

## 2. 世帯構成員の年齢と性別に基づく家族メンバー数（adult male equivalent）

```{r}

df_family_size <- get_familysize_ame(df_mod4)


```

## 3. 世帯の食費支出の計算

```{r}

df_food_consumption <- get_food_consumption(df_mod7)

```